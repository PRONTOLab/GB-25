name: "Compile or Run"

on:
  workflow_call:
    inputs:
      julia_version:
        description: 'Julia version'
        required: true
        default: ''
        type: string
      os:
        description: 'OS/Runner'
        required: true
        default: ''
        type: string
      xla_runtime:
        description: 'The XLA runtime'
        required: true
        default: ''
        type: string
      compile_or_run:
        description: 'We compile or run the code'
        required: true
        default: ''
        type: string
      earlyoom_threshold:
        description: 'earlyoom threshold'
        required: true
        default: 4
        type: number
      julia_optlevel:
        description: 'Julia optimization level'
        required: true
        default: 2
        type: number

jobs:
  ocean_climate_simulation:
    name: Julia ${{ inputs.julia_version }} - ${{ inputs.os }} - ${{ inputs.xla_runtime }} - ${{ inputs.compile_or_run }}
    runs-on: ${{ inputs.os }}
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        if: ${{ startsWith(inputs.os, 'ubuntu') }}
        with:
          version: ${{ inputs.julia_version }}
      - name: Ocean climate simulation
        timeout-minutes: 180
        run: |
          julia --color=yes -O${{ inputs.julia_optlevel }} ocean-climate-simulation/ocean_climate_simulation_${{ inputs.compile_or_run }}.jl
      - name: Upload MLIR modules
        uses: actions/upload-artifact@v4
        timeout-minutes: 10
        if: ${{ always() }}
        with:
          name: 'ocean-simulation-mlir-${{ inputs.julia_version }}-${{ inputs.os }}-${{ inputs.xla_runtime }}'
          path: |
            ocean-climate-simulation/**/*.mlir
          retention-days: 90
          overwrite: false
